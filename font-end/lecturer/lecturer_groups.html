<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Trang chia nh√≥m sinh vi√™n c·ªßa Gi·∫£ng vi√™n h∆∞·ªõng d·∫´n trong h·ªá th·ªëng Sinh vi√™n HUTECH.">
    <meta name="copyright" content="¬© 2025 - Nh√≥m TAD Programmer Khoa C√¥ng ngh·ªá Th√¥ng tin - Tr∆∞·ªùng ƒê·∫°i h·ªçc C√¥ng ngh·ªá TP.HCM - HUTECH. T·∫•t c·∫£ quy·ªÅn ƒë∆∞·ª£c b·∫£o l∆∞u.">
    <title>Chia nh√≥m sinh vi√™n | H·ªá th·ªëng Sinh vi√™n</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="/font-end/static/css/styles_lecturer.css" rel="stylesheet">
    <link href="/font-end/static/img/img_logohutech.png" type="image/png" rel="icon">
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <h4 class="text-center mb-4">üéì H·ªá th·ªëng Gi·∫£ng vi√™n h∆∞·ªõng d·∫´n</h4>
        <a href="/font-end/lecturer/lecturer_dashboard.html"><i class="bi bi-house-door"></i> T·ªïng quan</a>
        <div class="sidebar-section">
            <a href="/font-end/lecturer/lecturer_courses.html"><i class="bi bi-book"></i> ƒê·ªì √°n m√¥n h·ªçc</a>
            <a href="/font-end/lecturer/lecturer_course_approvals.html"><i class="bi bi-check-circle"></i> Duy·ªát ƒë·ªÅ t√†i</a>
            <a href="/font-end/lecturer/lecturer_tasks.html"><i class="bi bi-list-task"></i> Qu·∫£n l√Ω c√¥ng vi·ªác</a>
            <a href="/font-end/lecturer/lecturer_course_feedback.html"><i class="bi bi-chat-left-text"></i> Nh·∫≠n x√©t & ph·∫£n h·ªìi</a>
            <a href="/font-end/lecturer/lecturer_course_resources.html"><i class="bi bi-book"></i> G·ª£i √Ω t√†i li·ªáu</a>
            <a href="/font-end/lecturer/lecturer_course_reviews.html"><i class="bi bi-star"></i> ƒê√°nh gi√° t·ªïng quan</a>
            <a href="/font-end/lecturer/lecturer_course_groups.html" class="active"><i class="bi bi-people"></i> Chia nh√≥m sinh vi√™n</a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="content">
        <!-- Navbar -->
        <nav class="navbar navbar-expand-lg px-3">
            <button id="toggleSidebarBtn" class="btn btn-outline-light me-2">
                <i id="sidebarIcon" class="bi bi-list"></i>
            </button>            
            <button class="navbar-toggler toggle-btn" onclick="toggleSidebar()">
                <i class="bi bi-list"></i>
            </button>
            <div class="ms-auto d-flex align-items-center">
                <button id="toggleFullscreen" class="btn"><i class="bi bi-arrows-fullscreen"></i></button>
                <button id="toggleTheme" class="btn"><i class="bi bi-moon"></i></button>
                <button id="notificationBtn" class="btn"><i class="bi bi-bell"></i></button>
                <button id="profileBtn" class="btn"><i class="bi bi-person-circle"></i></button>
            </div>
        </nav>

        <!-- Profile Dropdown -->
        <div class="profile-dropdown" id="profileDropdown">
            <div class="profile-header">
                <img src="/font-end/static/medit/imgUser/avatar.jpg" alt="Lecturer Avatar">
                <h6 id="userName">Nguy·ªÖn Huy C∆∞·ªùng</h6>
                <p id="userEmail">nguyenhuycuong@hutech.edu.vn</p>
            </div>
            <div class="profile-menu">
                <a href="#"><i class="bi bi-gear"></i> C√†i ƒë·∫∑t hi·ªÉn th·ªã</a>
                <a href="#" id="toggleFullscreenBtn"><i class="bi bi-arrows-fullscreen"></i> To√†n m√†n h√¨nh</a>
                <a href="#"><i class="bi bi-arrow-clockwise"></i> Kh√¥i ph·ª•c m·∫∑c ƒë·ªãnh</a>
                <a href="#" class="logout" onclick="logout()"><i class="bi bi-box-arrow-right"></i> ƒêƒÉng xu·∫•t</a>
            </div>
        </div>

        <!-- Groups Section -->
        <div class="container mt-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="fw-bold text-primary">üë• Chia nh√≥m sinh vi√™n</h2>
                <div>
                    <button class="btn btn-success me-2" onclick="autoGroup()">Chia t·ª± ƒë·ªông</button>
                    <button class="btn btn-warning me-2" data-bs-toggle="modal" data-bs-target="#addGroupModal">Th√™m nh√≥m</button>
                    <input type="file" id="importExcel" accept=".xlsx" class="d-none" onchange="importFromExcel(event)">
                    <button class="btn btn-primary me-2" onclick="showImportInstructions()">Nh·∫≠p t·ª´ Excel</button>
                    <button class="btn btn-info" onclick="exportGroups()">Xu·∫•t Excel <i class="bi bi-file-earmark-excel"></i></button>
                </div>
            </div>

            <!-- Breadcrumb -->
            <nav class="breadcrumb-container">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/font-end/lecturer/lecturer_dashboard.html"><i class="bi bi-house-door"></i></a></li>
                    <li class="breadcrumb-item"><a href="/font-end/lecturer/lecturer_course_groups.html"><i class="bi bi-people"></i> Danh s√°ch m√¥n c·∫ßn chia nh√≥m</a></li>
                    <li class="breadcrumb-item active"><i class="bi bi-folder"></i> Chia nh√≥m sinh vi√™n</li>
                </ol>
            </nav>

            <!-- Group Settings -->
            <div class="mb-4">
                <label class="form-label fw-bold">S·ªë l∆∞·ª£ng t·ªëi ƒëa m·ªói nh√≥m:</label>
                <input type="number" id="groupSize" class="form-control w-25 d-inline-block" min="1" value="3" onchange="displayGroups()">
            </div>

            <!-- Students and Groups -->
            <div class="row">
                <!-- Danh s√°ch sinh vi√™n ch∆∞a chia nh√≥m -->
                <div class="col-md-6">
                    <div class="card-dashboard">
                        <div class="card-header">
                            <h5>Danh s√°ch sinh vi√™n ch∆∞a chia nh√≥m</h5>
                        </div>
                        <div class="card-content">
                            <ul id="studentList" class="list-group"></ul>
                        </div>
                    </div>
                </div>

                <!-- Danh s√°ch nh√≥m -->
                <div class="col-md-6">
                    <div class="card-dashboard">
                        <div class="card-header">
                            <h5>Danh s√°ch nh√≥m</h5>
                        </div>
                        <div class="card-content">
                            <div id="groupList"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Th√™m Nh√≥m -->
    <div class="modal fade" id="addGroupModal" tabindex="-1" aria-labelledby="addGroupModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addGroupModalLabel">Th√™m nh√≥m m·ªõi</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addGroupForm">
                        <div class="mb-3">
                            <label class="form-label">T√™n nh√≥m</label>
                            <input type="text" id="newGroupName" class="form-control" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="button" class="btn btn-primary" onclick="addNewGroup()">Th√™m</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Ch·ªânh s·ª≠a T√™n Nh√≥m -->
    <div class="modal fade" id="editGroupModal" tabindex="-1" aria-labelledby="editGroupModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editGroupModalLabel">Ch·ªânh s·ª≠a t√™n nh√≥m</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editGroupForm">
                        <input type="hidden" id="editGroupId">
                        <div class="mb-3">
                            <label class="form-label">T√™n nh√≥m m·ªõi</label>
                            <input type="text" id="editGroupName" class="form-control" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="button" class="btn btn-primary" onclick="updateGroupName()">L∆∞u</button>
                </div>
            </div>
        </div>
    </div>

    <div class="footer">
        B·∫£n quy·ªÅn c·ªßa HUTECH ‚Äì Ph√°t tri·ªÉn b·ªüi Team TAD Programmer ¬©2025
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = 'https://localhost:7047';
        const urlParams = new URLSearchParams(window.location.search);
        let selectedCourseId = urlParams.get("courseId");
        let groups = [];
        let students = [];

        // Navbar Functions
        document.getElementById("toggleSidebarBtn").addEventListener("click", () => toggleSidebar());
        document.getElementById("notificationBtn").addEventListener("click", () => window.location.href = "lecturer_notifications.html");
        document.getElementById("profileBtn").addEventListener("click", (event) => {
            event.stopPropagation();
            const dropdown = document.getElementById("profileDropdown");
            dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
        });
        document.addEventListener("click", (event) => {
            const dropdown = document.getElementById("profileDropdown");
            if (!dropdown.contains(event.target) && event.target.id !== "profileBtn") dropdown.style.display = "none";
        });
        document.getElementById("toggleFullscreen").addEventListener("click", () => {
            if (!document.fullscreenElement) document.documentElement.requestFullscreen();
            else document.exitFullscreen();
        });
        document.getElementById("toggleFullscreenBtn").addEventListener("click", () => {
            if (!document.fullscreenElement) document.documentElement.requestFullscreen();
            else document.exitFullscreen();
        });
        document.getElementById("toggleTheme").addEventListener("click", () => {
            document.body.classList.toggle("dark-mode");
            localStorage.setItem("theme", document.body.classList.contains("dark-mode") ? "dark" : "light");
        });
        if (localStorage.getItem("theme") === "dark") document.body.classList.add("dark-mode");

        // Toggle Sidebar
        function toggleSidebar() {
            let sidebar = document.querySelector(".sidebar");
            let content = document.querySelector(".content");
            let icon = document.getElementById("sidebarIcon");

            sidebar.classList.toggle("collapsed");
            content.classList.toggle("expanded");

            if (sidebar.classList.contains("collapsed")) {
                icon.classList.replace("bi-list", "bi-layout-sidebar-inset");
            } else {
                icon.classList.replace("bi-layout-sidebar-inset", "bi-list");
            }
        }

        // G·ª£i √Ω c·∫•u tr√∫c Excel tr∆∞·ªõc khi nh·∫≠p
        function showImportInstructions() {
            const instructions = `
                Vui l√≤ng chu·∫©n b·ªã file Excel v·ªõi c·∫•u tr√∫c sau:\n
                - C·ªôt A: T√™n nh√≥m (VD: Nh√≥m Alpha) - B·∫Øt bu·ªôc\n
                - C·ªôt B: Th√†nh vi√™n (VD: 21520001 - Nguy·ªÖn Tri B√£o Th·∫Øng, 21520002 - Tr·∫ßn VƒÉn A) - B·∫Øt bu·ªôc\n
                - C·ªôt C: Nh√≥m tr∆∞·ªüng (VD: 21520001) - Kh√¥ng b·∫Øt bu·ªôc (n·∫øu tr·ªëng, ch·ªçn SV ƒë·∫ßu ti√™n; ch·ªâ 1 ng∆∞·ªùi)\n
                D√≤ng 1-3 c√≥ th·ªÉ l√† ti√™u ƒë·ªÅ, d·ªØ li·ªáu b·∫Øt ƒë·∫ßu t·ª´ d√≤ng 4.
            `;
            if (confirm(instructions + "\nNh·∫•n OK ƒë·ªÉ ch·ªçn file Excel.")) {
                document.getElementById("importExcel").click();
            }
        }

        // L·ªçc danh s√°ch sinh vi√™n ch∆∞a chia nh√≥m
        async function filterStudents() {
            const searchText = document.querySelector(".search-box").value.toLowerCase();
            const response = await fetch(`${API_URL}/api/LecturerCourseGroup/ungrouped-students?courseId=${selectedCourseId}`, {
                method: "GET",
                headers: {
                    "Accept": "*/*",
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${localStorage.getItem("token")}`
                },
                credentials: "include"
            });
            students = await response.json();
            const studentList = document.getElementById("studentList");
            const ungroupedStudents = students.filter(s => !s.GroupId);

            studentList.innerHTML = ungroupedStudents.map(student => {
                if (student.name.toLowerCase().includes(searchText) || student.id.toLowerCase().includes(searchText)) {
                    return `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            ${student.username} - ${student.name} ${student.isLeader ? "(Nh√≥m tr∆∞·ªüng)" : ""}
                            <select class="form-select w-50" onchange="addToGroup('${student.id}', this.value)">
                                <option value="">Ch·ªçn nh√≥m</option>
                                ${groups.map(g => `<option value="${g.id}">${g.name} (${g.projectName})</option>`).join("")}
                            </select>
                        </li>
                    `;
                }
                return "";
            }).join("");

            if (!studentList.innerHTML) {
                studentList.innerHTML = '<li class="list-group-item text-center">Kh√¥ng c√≥ sinh vi√™n ch∆∞a chia nh√≥m</li>';
            }
        }

        // Hi·ªÉn th·ªã danh s√°ch nh√≥m
        async function displayGroups() {
            if (!selectedCourseId) {
                document.getElementById("studentList").innerHTML = '<li class="list-group-item text-center">Vui l√≤ng ch·ªçn m·ªôt m√¥n h·ªçc t·ª´ danh s√°ch ƒë·ªÉ chia nh√≥m.</li>';
                document.getElementById("groupList").innerHTML = '<p class="text-center">Vui l√≤ng ch·ªçn m·ªôt m√¥n h·ªçc t·ª´ danh s√°ch ƒë·ªÉ chia nh√≥m.</p>';
                return;
            }

            const groupSize = parseInt(document.getElementById("groupSize").value) || 3;
            const response = await fetch(`${API_URL}/api/LecturerCourseGroup/groups?courseId=${selectedCourseId}`, {
                method: "GET",
                headers: {
                    "Accept": "*/*",
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${localStorage.getItem("token")}`
                },
                credentials: "include"
            });
            groups = await response.json();
            const groupList = document.getElementById("groupList");
            groupList.innerHTML = "";

            groups.forEach(group => {
                const memberList = group.members.map(member => `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        ${member.username} - ${member.name} ${member.isLeader ? "(Nh√≥m tr∆∞·ªüng)" : ""}
                        <div>
                            <button class="btn btn-sm btn-warning me-1" onclick="toggleLeader('${member.id}', '${group.id}')">${member.isLeader ? "B·ªè nh√≥m tr∆∞·ªüng" : "Ch·ªçn nh√≥m tr∆∞·ªüng"}</button>
                            <button class="btn btn-sm btn-danger" onclick="removeFromGroup('${member.id}', '${group.id}')">X√≥a</button>
                        </div>
                    </li>
                `).join("");

                groupList.innerHTML += `
                    <div class="card mb-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6>${group.name} - ${group.projectName || "Ch∆∞a g√°n ƒë·ªì √°n"}</h6>
                            <div>
                                <button class="btn btn-sm btn-primary me-1" onclick="showEditGroupModal('${group.id}', '${group.name}')">Ch·ªânh s·ª≠a</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteGroup('${group.id}')">X√≥a</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <ul class="list-group">
                                ${memberList || '<li class="list-group-item text-center">Ch∆∞a c√≥ th√†nh vi√™n</li>'}
                            </ul>
                            <p class="mt-2">S·ªë l∆∞·ª£ng: ${group.members.length}/${groupSize}</p>
                        </div>
                    </div>
                `;
            });

            await filterStudents();
        }

        // Th√™m nh√≥m m·ªõi
        async function addNewGroup() {
            const form = document.getElementById("addGroupForm");
            if (form.checkValidity()) {
                const groupName = document.getElementById("newGroupName").value.trim();

                const response = await fetch(`${API_URL}/api/LecturerCourseGroup/add-group?groupName=${encodeURIComponent(groupName)}&courseId=${selectedCourseId}`, {
                    method: "POST",
                    headers: {
                        "Accept": "*/*",
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${localStorage.getItem("token")}`
                    },
                    credentials: "include"
                });

                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById("addGroupModal")).hide();
                    await displayGroups();
                    alert(`ƒê√£ th√™m nh√≥m: ${groupName}`);
                } else {
                    const error = await response.json();
                    alert(`L·ªói: ${error.message || "T√™n nh√≥m ƒë√£ t·ªìn t·∫°i trong m√¥n h·ªçc n√†y."}`);
                }
            } else {
                form.reportValidity();
            }
        }

        // Th√™m sinh vi√™n v√†o nh√≥m
        async function addToGroup(studentId, groupId) {
            const groupSize = parseInt(document.getElementById("groupSize").value) || 3;
            const response = await fetch(`${API_URL}/api/LecturerCourseGroup/add-to-group?studentId=${studentId}&groupId=${groupId}&groupSize=${groupSize}`, {
                method: "POST",
                headers: {
                    "Accept": "*/*",
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${localStorage.getItem("token")}`
                },
                credentials: "include"
            });

            if (response.ok) {
                await displayGroups();
            } else {
                const error = await response.json();
                alert(`L·ªói: ${error.message || "Nh√≥m ƒë√£ ƒë·∫ßy ho·∫∑c sinh vi√™n ƒë√£ thu·ªôc nh√≥m kh√°c."}`);
            }
        }

        // X√≥a sinh vi√™n kh·ªèi nh√≥m
        async function removeFromGroup(studentId, groupId) {
            const response = await fetch(`${API_URL}/api/LecturerCourseGroup/remove-from-group?studentId=${studentId}&groupId=${groupId}`, {
                method: "POST",
                headers: {
                    "Accept": "*/*",
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${localStorage.getItem("token")}`
                },
                credentials: "include"
            });

            if (response.ok) {
                await displayGroups();
            } else {
                const error = await response.json();
                alert(`L·ªói: ${error.message || "Kh√¥ng th·ªÉ x√≥a sinh vi√™n kh·ªèi nh√≥m."}`);
            }
        }

        // Ch·ªçn/b·ªè nh√≥m tr∆∞·ªüng
        async function toggleLeader(studentId, groupId) {
            const response = await fetch(`${API_URL}/api/LecturerCourseGroup/toggle-leader?studentId=${studentId}&groupId=${groupId}`, {
                method: "POST",
                headers: {
                    "Accept": "*/*",
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${localStorage.getItem("token")}`
                },
                credentials: "include"
            });

            if (response.ok) {
                await displayGroups();
            } else {
                const error = await response.json();
                alert(`L·ªói: ${error.message || "Kh√¥ng th·ªÉ thay ƒë·ªïi nh√≥m tr∆∞·ªüng."}`);
            }
        }

        // Chia nh√≥m t·ª± ƒë·ªông
        async function autoGroup() {
            const groupSize = parseInt(document.getElementById("groupSize").value) || 3;
            const response = await fetch(`${API_URL}/api/LecturerCourseGroup/auto-group`, {
                method: "POST",
                headers: {
                    "Accept": "*/*",
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${localStorage.getItem("token")}`
                },
                credentials: "include",
                body: JSON.stringify({ courseId: selectedCourseId, groupSize: groupSize })
            });

            if (response.ok) {
                await displayGroups();
                alert("ƒê√£ chia nh√≥m t·ª± ƒë·ªông!");
            } else {
                const error = await response.json();
                alert(`L·ªói: ${error.message || "Kh√¥ng th·ªÉ chia nh√≥m t·ª± ƒë·ªông."}`);
            }
        }

        // Nh·∫≠p t·ª´ file Excel
        function importFromExcel(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: "array" });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                // ƒê·ªçc d·ªØ li·ªáu v·ªõi ph√¢n c√°ch c·ªôt l√† |
                const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                console.log("Raw Rows:", rows);

                if (!rows || rows.length <= 3 || !rows.slice(3).some(row => row.length > 0)) {
                    alert("File Excel kh√¥ng ch·ª©a d·ªØ li·ªáu h·ª£p l·ªá t·ª´ d√≤ng 4 tr·ªü ƒëi. Vui l√≤ng ki·ªÉm tra l·∫°i file.");
                    return;
                }

                for (const row of rows.slice(3)) {
                    console.log("Row:", row);
                    const [groupName, membersStr, leaderId] = row; // Ph√¢n t√°ch c·ªôt theo |
                    console.log("groupName:", groupName);
                    console.log("membersStr:", membersStr);
                    console.log("leaderId:", leaderId);

                    if (groupName && membersStr) {
                        const members = membersStr.split(", ").map(m => {
                            const [username] = m.split(" - ");
                            return username.trim();
                        });
                        console.log("Members:", members);

                        let groupResponse = await fetch(`${API_URL}/api/LecturerCourseGroup/add-group?groupName=${encodeURIComponent(groupName)}&courseId=${selectedCourseId}`, {
                            method: "POST",
                            headers: {
                                "Accept": "*/*",
                                "Content-Type": "application/json",
                                "Authorization": `Bearer ${localStorage.getItem("token")}`
                            },
                            credentials: "include"
                        });

                        if (!groupResponse.ok) {
                            const error = await groupResponse.json();
                            alert(`L·ªói khi t·∫°o nh√≥m ${groupName}: ${error.message || "T√™n nh√≥m ƒë√£ t·ªìn t·∫°i."}`);
                            continue;
                        }

                        const newGroup = await groupResponse.json();
                        const groupId = newGroup.id;

                        for (const username of members) {
                            const userResponse = await fetch(`${API_URL}/api/LecturerCourseGroup/getIdByUsername?username=${username}`, {
                                method: "GET",
                                headers: {
                                    "Accept": "*/*",
                                    "Content-Type": "application/json",
                                    "Authorization": `Bearer ${localStorage.getItem("token")}`
                                },
                                credentials: "include"
                            });
                            alert(`Sinh vi√™n ${username}.`);
                            if (userResponse.ok) {
                                const userData = await userResponse.json();
                                const studentId = userData.id;

                                const checkResponse = await fetch(`${API_URL}/api/LecturerCourseGroup/check-student?studentId=${studentId}&courseId=${selectedCourseId}`, {
                                    method: "GET",
                                    headers: {
                                        "Accept": "*/*",
                                        "Content-Type": "application/json",
                                        "Authorization": `Bearer ${localStorage.getItem("token")}`
                                    },
                                    credentials: "include"
                                });
                                if (!checkResponse.ok) {
                                    const error = await checkResponse.json();
                                    alert(`L·ªói: Sinh vi√™n ${username} kh√¥ng thu·ªôc m√¥n h·ªçc ${selectedCourseId}.`);
                                    continue;
                                }

                                const addResponse = await fetch(`${API_URL}/api/LecturerCourseGroup/add-to-group?studentId=${studentId}&groupId=${groupId}&groupSize=5`, {
                                    method: "POST",
                                    headers: {
                                        "Accept": "*/*",
                                        "Content-Type": "application/json",
                                        "Authorization": `Bearer ${localStorage.getItem("token")}`
                                    },
                                    credentials: "include"
                                });
                                if (!addResponse.ok) {
                                    const error = await addResponse.json();
                                    alert(`L·ªói khi th√™m th√†nh vi√™n ${username} v√†o nh√≥m ${groupName}: ${error.message || "Nh√≥m ƒë√£ ƒë·∫ßy."}`);
                                }
                            } else {
                                alert(`L·ªói khi l·∫•y ID c·ªßa sinh vi√™n ${username}.`);
                            }
                        }

                        if (leaderId) {
                            const [leaderUsername] = leaderId.split(" - ");
                            const userResponse = await fetch(`${API_URL}/api/LecturerCourseGroup/getIdByUsername?username=${leaderUsername}`, {
                                method: "GET",
                                headers: {
                                    "Accept": "*/*",
                                    "Content-Type": "application/json",
                                    "Authorization": `Bearer ${localStorage.getItem("token")}`
                                },
                                credentials: "include"
                            });
                            if (userResponse.ok) {
                                const userData = await userResponse.json();
                                const leaderStudentId = userData.id;

                                const checkLeaderResponse = await fetch(`${API_URL}/api/LecturerCourseGroup/check-student?studentId=${leaderStudentId}&courseId=${selectedCourseId}`, {
                                    method: "GET",
                                    headers: {
                                        "Accept": "*/*",
                                        "Content-Type": "application/json",
                                        "Authorization": `Bearer ${localStorage.getItem("token")}`
                                    },
                                    credentials: "include"
                                });
                                if (!checkLeaderResponse.ok) {
                                    const error = await checkLeaderResponse.json();
                                    alert(`L·ªói: Sinh vi√™n ${leaderUsername} kh√¥ng thu·ªôc m√¥n h·ªçc ${selectedCourseId}.`);
                                    continue;
                                }

                                const leaderResponse = await fetch(`${API_URL}/api/LecturerCourseGroup/toggle-leader?studentId=${leaderStudentId}&groupId=${groupId}`, {
                                    method: "POST",
                                    headers: {
                                        "Accept": "*/*",
                                        "Content-Type": "application/json",
                                        "Authorization": `Bearer ${localStorage.getItem("token")}`
                                    },
                                    credentials: "include"
                                });
                                if (!leaderResponse.ok) {
                                    const error = await leaderResponse.json();
                                    alert(`L·ªói khi ƒë·∫∑t nh√≥m tr∆∞·ªüng ${leaderUsername} cho nh√≥m ${groupName}: ${error.message || "Kh√¥ng th·ªÉ ƒë·∫∑t nh√≥m tr∆∞·ªüng."}`);
                                }
                            } else {
                                alert(`L·ªói khi l·∫•y ID c·ªßa sinh vi√™n ${leaderUsername}.`);
                            }
                        }
                    } else {
                        alert("D·ªØ li·ªáu Excel kh√¥ng h·ª£p l·ªá: T√™n nh√≥m ho·∫∑c th√†nh vi√™n b·ªã thi·∫øu.");
                    }
                }

                await displayGroups();
                alert("ƒê√£ nh·∫≠p danh s√°ch nh√≥m t·ª´ Excel!");
            };
            reader.readAsArrayBuffer(file);
        }

        // Xu·∫•t danh s√°ch nh√≥m sang Excel
        async function exportGroups() {
            const response = await fetch(`${API_URL}/api/LecturerCourseGroup/export-excel?courseId=${selectedCourseId}`, {
                method: "GET",
                headers: {
                    "Accept": "*/*",
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${localStorage.getItem("token")}`
                },
                credentials: "include",
            });
            if (response.ok) {
                const blob = await response.blob();
                const courseResponse = await fetch(`${API_URL}/api/LecturerCourseGroup/courses`, {
                    method: "GET",
                    headers: {
                        "Accept": "*/*",
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${localStorage.getItem("token")}`
                    },
                    credentials: "include",
                });
                const courseData = await courseResponse.json();
                const course = courseData.courses.find(c => c.courseId === selectedCourseId);
                const fileName = `${course.Name}_${selectedCourseId}.xlsx`;
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = fileName;
                a.click();
                window.URL.revokeObjectURL(url);
            } else {
                const error = await response.json();
                alert(`L·ªói: ${error.message || "Kh√¥ng th·ªÉ xu·∫•t Excel."}`);
            }
        }

        // T·∫£i th√¥ng tin ng∆∞·ªùi d√πng
        async function loadUserProfile() {
            try {
                const user = JSON.parse(localStorage.getItem("user"));
                if (!user || user.roleName !== "ROLE_LECTURER_GUIDE") {
                    throw new Error("Kh√¥ng c√≥ quy·ªÅn Admin ho·∫∑c ch∆∞a ƒëƒÉng nh·∫≠p.");
                    logout();
                }
                document.getElementById("userName").textContent = user.fullName || "Nguy·ªÖn Huy C∆∞·ªùng";
                document.getElementById("userEmail").textContent = user.email || "nguyenhuycuong@hutech.edu.vn";
            } catch (error) {
                console.error('L·ªói khi t·∫£i th√¥ng tin ng∆∞·ªùi d√πng:', error);
                alert("Kh√¥ng c√≥ quy·ªÅn Gi·∫£ng vi√™n h∆∞·ªõng d·∫´n ho·∫∑c ch∆∞a ƒëƒÉng nh·∫≠p.");
                logout();
            }
        }

        // Hi·ªÉn th·ªã modal ch·ªânh s·ª≠a t√™n nh√≥m
        function showEditGroupModal(groupId, groupName) {
            document.getElementById("editGroupId").value = groupId;
            document.getElementById("editGroupName").value = groupName;
            new bootstrap.Modal(document.getElementById("editGroupModal")).show();
        }

        // C·∫≠p nh·∫≠t t√™n nh√≥m
        async function updateGroupName() {
            const groupId = document.getElementById("editGroupId").value;
            const newGroupName = document.getElementById("editGroupName").value.trim();

            const response = await fetch(`${API_URL}/api/LecturerCourseGroup/update-group-name?groupId=${groupId}&newGroupName=${newGroupName}`, {
                method: "POST",
                headers: {
                    "Accept": "*/*",
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${localStorage.getItem("token")}`
                },
                credentials: "include"
            });

            if (response.ok) {
                bootstrap.Modal.getInstance(document.getElementById("editGroupModal")).hide();
                await displayGroups();
                alert(`ƒê√£ c·∫≠p nh·∫≠t t√™n nh√≥m th√†nh: ${newGroupName}`);
            } else {
                const error = await response.json();
                alert(`L·ªói: ${error.message || "T√™n nh√≥m ƒë√£ t·ªìn t·∫°i trong m√¥n h·ªçc n√†y."}`);
            }
        }

        // X√≥a nh√≥m
        async function deleteGroup(groupId) {
            if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a nh√≥m n√†y? C√°c th√†nh vi√™n s·∫Ω ƒë∆∞·ª£c chuy·ªÉn v·ªÅ ch∆∞a c√≥ nh√≥m.")) {
                const response = await fetch(`${API_URL}/api/LecturerCourseGroup/delete-group?groupId=${groupId}`, {
                    method: "POST",
                    headers: {
                        "Accept": "*/*",
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${localStorage.getItem("token")}`
                    },
                    credentials: "include"
                });

                if (response.ok) {
                    await displayGroups();
                    alert("ƒê√£ x√≥a nh√≥m th√†nh c√¥ng!");
                } else {
                    const error = await response.json();
                    alert(`L·ªói: ${error.message || "Kh√¥ng th·ªÉ x√≥a nh√≥m."}`);
                }
            }
        }

        // Ghi ch√∫: ƒêƒÉng xu·∫•t
        async function logout() {
            try {
                const response = await fetch(`${API_URL}/api/Auth/logout`, {
                    method: "POST",
                    headers: {
                        "Accept": "*/*",
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${localStorage.getItem("token")}`
                    },
                    credentials: "include"
                });
                const text = await response.text();
                if (response.ok) {
                    const data = text ? JSON.parse(text) : {};
                    alert(data.message || "ƒê√£ ƒëƒÉng xu·∫•t th√†nh c√¥ng.");
                } else {
                    const data = text ? JSON.parse(text) : {};
                    alert(`ƒêƒÉng xu·∫•t th·∫•t b·∫°i: ${data.message || response.statusText}`);
                }
            } catch (error) {
                alert("ƒêƒÉng xu·∫•t b·ªã l·ªói: " + error.message);
                console.error("ƒêƒÉng xu·∫•t b·ªã l·ªói:", error);
            }
            localStorage.removeItem("user");
            localStorage.removeItem("token");
            window.location.replace("/font-end/login/login.html");
        }

        // Kh·ªüi ch·∫°y
        document.addEventListener("DOMContentLoaded", async () => {
            try {
                if (!selectedCourseId) {
                    alert("Vui l√≤ng ch·ªçn m·ªôt m√¥n h·ªçc t·ª´ danh s√°ch ƒë·ªÉ chia nh√≥m!");
                    window.location.href = "lecturer_course_groups.html";
                    return;
                }
                await loadUserProfile();
                await displayGroups();
            } catch (error) {
                console.error("L·ªói khi t·∫£i b·∫£ng ƒëi·ªÅu khi·ªÉn:", error);
                alert(`Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu: ${error.message || "Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i."}`);
                logout();
            }
        });
    </script>
</body>
</html>